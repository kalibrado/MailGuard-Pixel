<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixel Tracker Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px 30px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: #333;
      font-size: 32px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      background: #10b981;
      color: white;
    }

    .pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: white;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }

    .stat-icon {
      font-size: 40px;
      margin-bottom: 15px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }

    .chart-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-btn:hover {
      background: #5568d3;
      transform: scale(1.05);
    }

    .refresh-btn:active {
      transform: scale(0.95);
    }

    .log-table {
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }

    .table-header {
      padding: 25px;
      border-bottom: 2px solid #e5e7eb;
    }

    .table-content {
      max-height: 500px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f9fafb;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #e5e7eb;
      color: #4b5563;
    }

    tr:hover {
      background: #f9fafb;
    }

    .type-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .type-internal {
      background: #dbeafe;
      color: #1e40af;
    }

    .type-external {
      background: #fee2e2;
      color: #991b1b;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 18px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .time-filter {
      display: flex;
      gap: 10px;
    }

    .time-btn {
      padding: 8px 16px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .time-btn.active {
      background: #667eea;
      color: white;
    }

    .time-btn:hover {
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 24px;
      }

      .table-content {
        max-height: 400px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>
        Pixel Tracker Dashboard
        <span class="status-badge">
          <span class="pulse"></span>
          LIVE
        </span>
      </h1>
      <div class="controls">
        <button class="refresh-btn" onclick="refreshData()">
          üîÑ Actualiser
        </button>
        <div class="time-filter">
          <button class="time-btn active" onclick="setTimeFilter('1h')">1H</button>
          <button class="time-btn" onclick="setTimeFilter('24h')">24H</button>
          <button class="time-btn" onclick="setTimeFilter('7d')">7J</button>
          <button class="time-btn" onclick="setTimeFilter('30d')">30J</button>
        </div>
      </div>
    </header>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-value" id="total-hits">0</div>
        <div class="stat-label">Total Hits</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üè†</div>
        <div class="stat-value" id="internal-hits">0</div>
        <div class="stat-label">Hits Internes</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üåç</div>
        <div class="stat-value" id="external-hits">0</div>
        <div class="stat-label">Hits Externes</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">‚ö°</div>
        <div class="stat-value" id="hits-per-min">0</div>
        <div class="stat-label">Hits/Min</div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">üìà Trafic dans le temps</div>
      <canvas id="trafficChart" height="80"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">üåé R√©partition G√©ographique</div>
      <canvas id="geoChart" height="100"></canvas>
    </div>

    <div class="log-table">
      <div class="table-header">
        <div class="chart-title">üìã Derni√®res Requ√™tes (Live)</div>
      </div>
      <div class="table-content">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Type</th>
              <th>IP Hash</th>
              <th>Pays</th>
              <th>User Agent</th>
              <th>Referer</th>
            </tr>
          </thead>
          <tbody id="log-body">
            <tr>
              <td colspan="6" class="loading">
                <div class="spinner"></div>
                Chargement des donn√©es...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const API_URL = window.location.origin;
    let currentTimeFilter = '1h';
    let trafficChart, geoChart;
    let autoRefreshInterval;

    // Donn√©es simul√©es pour la d√©mo
    function generatedata() {
      const now = Date.now();
      const entries = [];
      const countries = ['France', 'USA', 'UK', 'Germany', 'Spain', 'Italy', 'Canada'];
      const userAgents = [
        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0',
        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) Safari/17.2',
        'Mozilla/5.0 (X11; Linux x86_64) Firefox/121.0',
        'Mozilla/5.0 (iPhone; CPU iPhone OS 17_2 like Mac OS X) Safari/17.2'
      ];
      const referers = ['https://google.com', 'https://facebook.com', 'direct', 'https://twitter.com'];

      for (let i = 0; i < 100; i++) {
        const timestamp = new Date(now - Math.random() * 3600000);
        const isExternal = Math.random() > 0.3;

        entries.push({
          timestamp: timestamp.toISOString(),
          hit_id: Math.random().toString(36).substr(2, 8),
          ip_hash: Math.random().toString(36).substr(2, 12),
          type: isExternal ? 'EXTERNAL' : 'INTERNAL',
          user_agent: userAgents[Math.floor(Math.random() * userAgents.length)],
          referer: referers[Math.floor(Math.random() * referers.length)],
          geo: isExternal ? {
            country: countries[Math.floor(Math.random() * countries.length)],
            city: 'Paris'
          } : null
        });
      }

      return entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }

    // Initialisation des graphiques
    function initCharts() {
      const trafficCtx = document.getElementById('trafficChart').getContext('2d');
      trafficChart = new Chart(trafficCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Hits Totaux',
            data: [],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: 'Hits Externes',
            data: [],
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });

      const geoCtx = document.getElementById('geoChart').getContext('2d');
      geoChart = new Chart(geoCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Hits par Pays',
            data: [],
            backgroundColor: [
              '#667eea', '#764ba2', '#f093fb', '#4facfe',
              '#43e97b', '#fa709a', '#fee140', '#30cfd0'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          indexAxis: 'y',
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }

    // Mise √† jour des statistiques
    function updateStats(data) {
      const totalHits = data.length;
      const internalHits = data.filter(d => d.type === 'INTERNAL').length;
      const externalHits = data.filter(d => d.type === 'EXTERNAL').length;

      // Calcul des hits par minute (derni√®re heure)
      const oneHourAgo = Date.now() - 3600000;
      const recentHits = data.filter(d => new Date(d.timestamp).getTime() > oneHourAgo);
      const hitsPerMin = (recentHits.length / 60).toFixed(1);

      document.getElementById('total-hits').textContent = totalHits;
      document.getElementById('internal-hits').textContent = internalHits;
      document.getElementById('external-hits').textContent = externalHits;
      document.getElementById('hits-per-min').textContent = hitsPerMin;
    }

    // Mise √† jour du graphique de trafic
    function updateTrafficChart(data) {
      const now = Date.now();
      const timeRanges = [];
      const totalCounts = [];
      const externalCounts = [];

      // Cr√©er des tranches de 5 minutes sur la derni√®re heure
      for (let i = 11; i >= 0; i--) {
        const time = new Date(now - i * 300000);
        const label = time.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        timeRanges.push(label);

        const rangeStart = time.getTime();
        const rangeEnd = rangeStart + 300000;

        const rangeData = data.filter(d => {
          const timestamp = new Date(d.timestamp).getTime();
          return timestamp >= rangeStart && timestamp < rangeEnd;
        });

        totalCounts.push(rangeData.length);
        externalCounts.push(rangeData.filter(d => d.type === 'EXTERNAL').length);
      }

      trafficChart.data.labels = timeRanges;
      trafficChart.data.datasets[0].data = totalCounts;
      trafficChart.data.datasets[1].data = externalCounts;
      trafficChart.update();
    }

    // Mise √† jour du graphique g√©ographique
    function updateGeoChart(data) {
      const countryCounts = {};

      data.forEach(entry => {
        if (entry.geo && entry.geo.country) {
          const country = entry.geo.country;
          countryCounts[country] = (countryCounts[country] || 0) + 1;
        }
      });

      const sortedCountries = Object.entries(countryCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

      geoChart.data.labels = sortedCountries.map(c => c[0]);
      geoChart.data.datasets[0].data = sortedCountries.map(c => c[1]);
      geoChart.update();
    }

    // Mise √† jour du tableau de logs
    function updateLogTable(data) {
      const tbody = document.getElementById('log-body');
      tbody.innerHTML = '';

      const recentData = data.slice(0, 50);

      recentData.forEach(entry => {
        const row = document.createElement('tr');

        const timestamp = new Date(entry.timestamp).toLocaleString('fr-FR');
        const typeBadge = `<span class="type-badge type-${entry.type.toLowerCase()}">${entry.type}</span>`;
        const country = entry.geo ? entry.geo.country : '-';
        const userAgent = entry.user_agent.substring(0, 50) + '...';
        const referer = entry.referer === 'none' ? '-' : entry.referer.substring(0, 30) + '...';

        row.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${typeBadge}</td>
                    <td>${entry.ip_hash}</td>
                    <td>${country}</td>
                    <td title="${entry.user_agent}">${userAgent}</td>
                    <td title="${entry.referer}">${referer}</td>
                `;

        tbody.appendChild(row);
      });
    }

    async function fetchRealData() {
      try {
        const response = await fetch(`${API_URL}/api/logs?filter=${currentTimeFilter}`);
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Erreur chargement donn√©es:', error);
      }
    }


    // Rafra√Æchir toutes les donn√©es
    async function refreshData() {
      const data =  await fetchRealData(); // generatedata() //

      updateStats(data);
      updateTrafficChart(data);
      updateGeoChart(data);
      updateLogTable(data);
    }

    // Filtre temporel
    function setTimeFilter(filter) {
      currentTimeFilter = filter;

      document.querySelectorAll('.time-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      refreshData();
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      refreshData();

      // Auto-refresh toutes les 10 secondes
      autoRefreshInterval = setInterval(refreshData, 10000);
    });

    // Nettoyage √† la fermeture
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
</body>

</html>